From cf49af361091fd256bc26539051e260ee0505ed0 Mon Sep 17 00:00:00 2001
From: Jonas Karlman <jonas@kwiboo.se>
Date: Wed, 23 Jul 2025 22:22:36 +0000
Subject: [PATCH 08/51] rockchip: rk3528: Add support for booting from SPI
 flash

Signed-off-by: Jonas Karlman <jonas@kwiboo.se>
---
 arch/arm/dts/rk3528-u-boot.dtsi        | 27 ++++++++++++++++++++++++++
 arch/arm/mach-rockchip/rk3528/rk3528.c |  1 +
 2 files changed, 28 insertions(+)

diff --git a/arch/arm/dts/rk3528-u-boot.dtsi b/arch/arm/dts/rk3528-u-boot.dtsi
index a18d33b3d36..17a2d0ec3ff 100644
--- a/arch/arm/dts/rk3528-u-boot.dtsi
+++ b/arch/arm/dts/rk3528-u-boot.dtsi
@@ -6,6 +6,7 @@
 	aliases {
 		mmc0 = &sdhci;
 		mmc1 = &sdmmc;
+		spi2 = &sfc;
 	};
 
 	chosen {
@@ -30,6 +31,17 @@
 	};
 };
 
+#ifdef CONFIG_ROCKCHIP_SPI_IMAGE
+&binman {
+	simple-bin-spi {
+		mkimage {
+			args = "-n", CONFIG_SYS_SOC, "-T", "rksd";
+			offset = <0x8000>;
+		};
+	};
+};
+#endif
+
 &cru {
 	bootph-all;
 };
@@ -54,6 +66,16 @@
 	bootph-some-ram;
 };
 
+&fspi_csn0 {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&fspi_pins {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
 &gmac0_clk {
 	bootph-all;
 };
@@ -115,6 +137,11 @@
 	bootph-some-ram;
 };
 
+&sfc {
+	bootph-some-ram;
+	u-boot,spl-sfc-no-dma;
+};
+
 &uart0 {
 	bootph-all;
 	clock-frequency = <24000000>;
diff --git a/arch/arm/mach-rockchip/rk3528/rk3528.c b/arch/arm/mach-rockchip/rk3528/rk3528.c
index f9bfc445b85..7ae8680fb04 100644
--- a/arch/arm/mach-rockchip/rk3528/rk3528.c
+++ b/arch/arm/mach-rockchip/rk3528/rk3528.c
@@ -20,6 +20,7 @@
 
 const char * const boot_devices[BROM_LAST_BOOTSOURCE + 1] = {
 	[BROM_BOOTSOURCE_EMMC] = "/soc/mmc@ffbf0000",
+	[BROM_BOOTSOURCE_SPINOR] = "/soc/spi@ffc00000/flash@0",
 	[BROM_BOOTSOURCE_SD] = "/soc/mmc@ffc30000",
 };
 
-- 
2.34.1

